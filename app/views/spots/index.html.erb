<div class="container">
  
  <!-- form_withはデフォルトでremote: true(リクエストがhtml形式ではなくjs形式になる) -->
  <%= form_with url: map_search_path, method: :get do |f|%>
    <%= f.text_field :address %>
    <%= f.submit '地図表示' %>
  <% end %>

  <div id='map'></div>

  <%= form_with url: spots_path, method: :post do |f| %>
    <h4>住所</h4>
    <%= f.text_field :address, id: :address_field %>
    <h4>緯度</h4>
    <%= f.text_field :latitude, id: :latitude %>
    <h4>経度</h4>
    <%= f.text_field :longitude, id: :longitude %>
    <h4>場所の名前</h4>
    <%= f.text_field :spot_name %>
    <h4>場所の説明</h4>
    <%= f.text_field :spot_body %>
    <h4>カテゴリー</h4>
    <%= f.text_field :category %>
    <h4>ユーザーID</h4>
    <%= f.text_field :user_id %>
    <h4>場所の画像</h4>
    <%# <%= f.attachment_field :spot_image %>
    <%= f.submit '登録' %>
  <% end %>

<script>
// functionの中に入れちゃダメ
var mapInstance;
var makerJs;
var infoWindow;
function initMap(){
  mapInstance = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 35.6628611, lng: 139.6972762},
    zoom: 15,
    mapTypeControl: false,
    streetViewControl: false,
    gestureHandling: 'cooperative',
  });

 // 登録されているspotがピンで表示されるようにする
 <% @spots.each do |spot| %>
  makerJs = new google.maps.Marker({
    map: mapInstance,
    position: new google.maps.LatLng(
      <%= spot.latitude %>, //latitude
      <%= spot.longitude %>  //longitude
      )
 });
 <% end %>

  var contentString = '<div id="message">message</div>'
  infoWindow = new google.maps.InfoWindow({
    content: contentString
  });
  markerJs.addListener('click', function(){
    infoWindow.open(mapInstance, markerJs);
  });
}
</script>

 <%# application.html.erbに記述すると、redirect時などに表示されなくなる %>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBucemSsqWHgDVSWR5MJG9kEh2Zvl2yOWw&callback=initMap">
  </script>

</div>